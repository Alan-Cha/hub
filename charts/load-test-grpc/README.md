# Benchmark and Validate gRPC Services

> Use Iter8's `load-test-grpc` experiment chart to generate call requests for gRPC services, collect Iter8's built-in latency and error-related metrics, and validate service-level objectives (SLOs).

***

**Use-cases:** 

- Benchmarking
- Validation of service level objectives (SLOs)
- Safe rollouts
- Continuous delivery (CD)

If the gRPC service satisfies SLOs, it may be safely rolled out, for example, from a test environment to production.  

> Note: The parameters supported by `load-test-grpc` are inherited for the most part from [ghz](https://ghz.sh/docs/options).

***

## Basic example
Load test a [unary gRPC](https://grpc.io/docs/what-is-grpc/core-concepts/#unary-rpc) service as follows by specifying its `host`, its fully-qualified method name (`call`), and the URL of Protocol Buffer file (`protoURL`) defining the service.

```shell
iter8 launch -c load-test-grpc \
          --set host="127.0.0.1:50051" \
          --set call="helloworld.Greeter.SayHello" \
          --set protoURL="https://raw.githubusercontent.com/grpc/grpc-go/master/examples/helloworld/helloworld/helloworld.proto"
```

***

## Metrics and SLOs
By default, the following metrics are collected by `load-test-grpc`: 

- `request-count`: total number of requests sent
- `error-count`: number of error responses
- `error-rate`: fraction of error responses
- `latency/mean`: mean of observed latency values
- `latency/stddev`: standard deviation of observed latency values
- `latency/min`: min of observed latency values
- `latency/max`: max of observed latency values
- `latency/pX`: X^th^ percentile of observed latency values, for `X` in `[50.0, 75.0, 90.0, 95.0, 99.0, 99.9]`

In addition, any other latency percentiles that are specified as part of SLOs are also collected. 

***

```shell
iter8 launch -c load-test-grpc \
          --set host="127.0.0.1:50051" \
          --set call="helloworld.Greeter.SayHello" \
          --set protoURL="https://raw.githubusercontent.com/grpc/grpc-go/master/examples/helloworld/helloworld/helloworld.proto" \ 
          --set SLOs.error-rate=0 \
          --set SLOs.latency-mean=50 \
          --set SLOs.latency-p90=100 \
          --set SLOs.latency-p'97\.5'=200
```

In the above example, The following SLOs are validated.

- error rate is 0
- mean latency is under 50 msec
- 90th percentile latency is under 100 msec
- 97.5th percentile latency is under 200 msec

***

## Load profile
Control the characteristics of the load generated by the `load-test-grpc` experiment by  setting the number of requests (`total`)/duration (`duration`), the number of requests per second (`rps`), number of connections to use (`connections`), and the number of concurrent request workers to use in each connection (`concurrency`).


### Number of requests
```shell
iter8 launch -c load-test-grpc \
          --set host="127.0.0.1:50051" \
          --set call="helloworld.Greeter.SayHello" \
          --set protoURL="https://raw.githubusercontent.com/grpc/grpc-go/master/examples/helloworld/helloworld/helloworld.proto" \
          --set data.name="frodo" \
          --set total=500 \
          --set rps=25 \
          --set concurrency=50 \
          --set connections=10
```

### Duration
The duration value may be any [Go duration string](https://pkg.go.dev/maze.io/x/duration#ParseDuration).

```shell
iter8 launch -c load-test-grpc \
          --set host="127.0.0.1:50051" \
          --set call="helloworld.Greeter.SayHello" \
          --set protoURL="https://raw.githubusercontent.com/grpc/grpc-go/master/examples/helloworld/helloworld/helloworld.proto" \
          --set data.name="frodo" \
          --set duration="20s" \
          --set rps=25 \
          --set concurrency=50 \
          --set connections=10
```

When you set `total` and `qps`, the duration of the load test is automatically determined. Similarly, when you set `duration` and `qps`, the number of requests is automatically determined. If you set both `total` and `duration`, the former will be ignored.

### Call data
gRPC calls may include data serialized as [Protocol Buffer messages](https://grpc.io/docs/what-is-grpc/introduction/#working-with-protocol-buffers). Supply them as values, or by pointing to JSON or binary files containing the data.

#### Data
The [protobuf file specifying the gRPC service](https://raw.githubusercontent.com/grpc/grpc-go/master/examples/helloworld/helloworld/helloworld.proto) used in this tutorial defines the following `HelloRequest` message format:
```protobuf
message HelloRequest {
  string name = 1;
}
```

Suppose you want include the following `HelloRequest` message with every call.
```yaml
name: frodo
```

To do so, run the Iter8 experiment as follows.
```shell
iter8 launch -c load-test-grpc \
          --set host="127.0.0.1:50051" \
          --set call="helloworld.Greeter.SayHello" \
          --set protoURL="https://raw.githubusercontent.com/grpc/grpc-go/master/examples/helloworld/helloworld/helloworld.proto" \
          --set data.name="frodo"
```

##### Nested data
Call data may be nested. For example, consider the data:
```yaml
name: frodo
realm:
  planet: earth
  location: middle
```
You can set the above data during `iter8 launch` as follows:
```shell
--set data.name="frodo" \
--set data.realm.planet="earth" \
--set data.realm.location="middle" 
```

#### Data file
Suppose the call data you want to send is contained in a local JSON file. Iter8 can use the data contained in it during the gRPC load test. To do so, run the experiment as follows.

```shell
iter8 launch -c load-test-grpc \
          --set host="127.0.0.1:50051" \
          --set call="helloworld.Greeter.SayHello" \
          --set protoURL="https://raw.githubusercontent.com/grpc/grpc-go/master/examples/helloworld/helloworld/helloworld.proto" \
          --set dataFile="/the/path/to/data.json" # "./data.json" also works
```

#### Data URL
Suppose the call data you want to send is contained in a JSON file and hosted at the url https://location.of/data.json. Iter8 can fetch this JSON file and use the data contained in it during the gRPC load test. To do so, run the experiment as follows.

```shell
iter8 launch -c load-test-grpc \
          --set host="127.0.0.1:50051" \
          --set call="helloworld.Greeter.SayHello" \
          --set protoURL="https://raw.githubusercontent.com/grpc/grpc-go/master/examples/helloworld/helloworld/helloworld.proto" \
          --set dataURL="https://location.of/data.json"
```

#### Binary data file
Suppose the call data you want to send is contained in a local binary file as a serialized binary message or multiple count-prefixed messages. Iter8 can use the data contained in it during the gRPC load test. To do so, run the experiment as follows.

```shell
iter8 launch -c load-test-grpc \
          --set host="127.0.0.1:50051" \
          --set call="helloworld.Greeter.SayHello" \
          --set protoURL="https://raw.githubusercontent.com/grpc/grpc-go/master/examples/helloworld/helloworld/helloworld.proto" \
          --set binaryDataFile="/the/path/to/data.bin" # "./data.bin" also works
```

#### Binary data URL
Suppose that call data you want to send is contained in a binary file as a serialized binary message or multiple count-prefixed messages, and hosted at the url https://location.of/data.bin. Iter8 can fetch this binary file and use the data contained in it during the gRPC load test. To do so, run the experiment as follows.

```shell
iter8 launch -c load-test-grpc \
          --set host="127.0.0.1:50051" \
          --set call="helloworld.Greeter.SayHello" \
          --set protoURL="https://raw.githubusercontent.com/grpc/grpc-go/master/examples/helloworld/helloworld/helloworld.proto" \
          --set binaryDataURL="https://location.of/data.bin"
```

If more than one of the above parameters are specified, the order of precedence is as follows: 

```
Data > Data file > Data URL > Binary data file > Binary data URL
```

***

## Call metadata
gRPC calls may include [metadata](https://grpc.io/docs/what-is-grpc/core-concepts/#metadata) which is information about a particular call. Supply them as values, or by pointing to a JSON file containing the metadata.

### Metadata
You can supply metadata of type `map[string]string` (i.e., a map whose keys and values are strings) in the `gRPC` load test. Suppose you want to use the following metadata.
```yaml
darth: vader
lord: sauron
volde: mort
```

To do so, run the Iter8 experiment as follows.
```shell
iter8 launch -c load-test-grpc \
          --set host="127.0.0.1:50051" \
          --set call="helloworld.Greeter.SayHello" \
          --set protoURL="https://raw.githubusercontent.com/grpc/grpc-go/master/examples/helloworld/helloworld/helloworld.proto" \
          --set metadata.darth="vader" \
          --set metadata.lord="sauron" \
          --set metadata.volde="mort"
```

### Metadata file
Suppose the call metadata you want to send is contained in a local JSON file. Iter8 can use the metadata contained in it during the gRPC load test. To do so, run the experiment as follows.

```shell
iter8 launch -c load-test-grpc \
          --set host="127.0.0.1:50051" \
          --set call="helloworld.Greeter.SayHello" \
          --set protoURL="https://raw.githubusercontent.com/grpc/grpc-go/master/examples/helloworld/helloworld/helloworld.proto" \
          --set metadataFile="/the/path/to/metadata.json" # "./metadata.json" also works
```

### Metadata URL
Suppose the call metadata you want to send is contained in a JSON file and hosted at the url https://location.of/metadata.json. Iter8 can fetch this JSON file and use its contents as the metadata during the gRPC load test. To do so, run the experiment as follows.

```shell
iter8 launch -c load-test-grpc \
          --set host="127.0.0.1:50051" \
          --set call="helloworld.Greeter.SayHello" \
          --set protoURL="https://raw.githubusercontent.com/grpc/grpc-go/master/examples/helloworld/helloworld/helloworld.proto" \
          --set metadataURL="https://location.of/metadata.json"
```

If more than one of the above parameters are specified, the order of precedence is as follows: 

```
Metadata > Metadata file > Metadata URL
```

***

## Proto and reflection

The gRPC server method signatures and message formats are defined in a `.proto` source file or a compiled `.protoset` file. Supply them as follows.

### Proto file
Supply the name of a `.proto` source file.

```shell
iter8 launch -c load-test-grpc \
          --set host="127.0.0.1:50051" \
          --set call="helloworld.Greeter.SayHello" \
          --set protoURL="/path/to/helloworld.proto" # "./helloworld.proto" also works
```


### Proto URL
Supply a URL that hosts a `.proto` source file.

```shell
iter8 launch -c load-test-grpc \
          --set host="127.0.0.1:50051" \
          --set call="helloworld.Greeter.SayHello" \
          --set protoURL="https://raw.githubusercontent.com/grpc/grpc-go/master/examples/helloworld/helloworld/helloworld.proto"
```

### Protoset file
Supply the name of a `.protoset` file that is compiled from `.proto` source files.

```shell
iter8 launch -c load-test-grpc \
          --set host="127.0.0.1:50051" \
          --set call="helloworld.Greeter.SayHello" \
          --set protoset="./myservice.protoset"
```

### Protoset URL
Supply a URL that hosts a `.protoset` file.

```shell
iter8 launch -c load-test-grpc \
          --set host="127.0.0.1:50051" \
          --set call="helloworld.Greeter.SayHello" \
          --set protosetURL="https://raw.githubusercontent.com/grpc/grpc-go/master/examples/helloworld/helloworld/helloworld.protoset"
```

### Reflection
In the absence of `.proto` and `.protoset` information, the `load-test-grpc` experiment will attempt to use [server reflection](https://github.com/grpc/grpc/blob/master/doc/server-reflection.md). You can supply reflect metadata as values.

```shell
iter8 launch -c load-test-grpc \
          --set host="127.0.0.1:50051" \
          --set call="helloworld.Greeter.SayHello" \
          --set reflectMetadata.clientId="5hL64dd0" \
          --set reflectMetadata.clientMood="delightful"
```

***

## Streaming gRPC

### Call data

For client streaming or bi-directional calls, the `load-test-grpc` chart accepts an array of messages, each element representing a single message within the stream call. For example, 

```shell
iter8 launch -c load-test-grpc \
          --set host="127.0.0.1:50051" \
          --set call="helloworld.Greeter.SayHello" \
          --set protoURL="https://raw.githubusercontent.com/grpc/grpc-go/master/examples/helloworld/helloworld/helloworld.proto" \
          --set data[0].name="Joe" \
          --set data[1].name="Kate" \
          --set data[2].name="Sara"
```
    
If a single object is given for data then it is automatically converted to an array with single element. In case of client streaming, `load-test-grpc` sends all the messages in the input array, and then closes and receives.

***

### Stream interval

Stream interval duration spreads stream sends by given amount, specified as a [Go duration string](https://pkg.go.dev/maze.io/x/duration#ParseDuration). This parameter applies to client and bidirectional streaming calls.

```shell
iter8 launch -c load-test-grpc \
          --set host="127.0.0.1:50051" \
          --set call="helloworld.Greeter.SayHello" \
          --set protoURL="https://raw.githubusercontent.com/grpc/grpc-go/master/examples/helloworld/helloworld/helloworld.proto" \
          --set data[0].name="Joe" \
          --set streamInterval="100ms"
```

***

### Stream call duration

This parameter sets the maximum stream call duration. For client streaming and bidirectional calls, `load-test-grpc` will send messages until this duration expires. For server streaming calls, `load-test-grpc` will receive messages until the duration has expired. In server streaming calls, expiration of this duration will result in a call cancelled error.

```shell
iter8 launch -c load-test-grpc \
          --set host="127.0.0.1:50051" \
          --set call="helloworld.Greeter.SayHello" \
          --set protoURL="https://raw.githubusercontent.com/grpc/grpc-go/master/examples/helloworld/helloworld/helloworld.proto" \
          --set data[0].name="Joe" \
          --set streamCallDuration="500ms"
```

***

### Stream call count

This parameter sets the maximum number of message sends or receives that will be performed by `load-test-grpc` in a streaming call, before closing the stream and ending the call. 

For client streaming and bidirectional calls, this represents the number of messages sent. For server streaming calls `load-test-grpc` will receive messages until the specified count is reached. Note that in server streaming calls, reaching this count will result in a call cancelled error.

```shell
iter8 launch -c load-test-grpc \
          --set host="127.0.0.1:50051" \
          --set call="helloworld.Greeter.SayHello" \
          --set protoURL="https://raw.githubusercontent.com/grpc/grpc-go/master/examples/helloworld/helloworld/helloworld.proto" \
          --set data[0].name="Joe" \
          --set streamCallCount=100
```

If the data array contains more elements than the count, only messages up to the specified count will be used. If the data array contains fewer elements than the count specified, the data will be iterated over until the specified count is reached.

