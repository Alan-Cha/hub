---
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: {{ $.Release.Name }}-traffic
  {{ template "iter8-traffic.labels" $ }}
rules:
{{- range $typeName, $type := .Values.resourceTypes }}
{{- if not $type.resource }}
{{- fail (print "resourceType \"" (print $typeName "\" does not have a resource parameter")) }}
{{- end }}
- apiGroups: ["{{- $type.group -}}"]
  resources: ["{{- $type.resource -}}"]
  verbs: ["read", "watch"]
{{- end }}
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: {{ $.Release.Name }}-traffic
  {{ template "iter8-traffic.labels" $ }}
subjects:
- kind: ServiceAccount
  name: {{ $.Release.Name }}
roleRef:
  kind: Role
  name: {{ $.Release.Name }}-traffic
  apiGroup: rbac.authorization.k8s.io